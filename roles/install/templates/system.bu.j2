variant: fcos
version: "{{ butane_version }}"

systemd:
  units:
    - name: rpm-ostree-countme.timer
      enabled: false
      mask: true

storage:
  links:
    - path: /etc/localtime
      target: ../usr/share/zoneinfo/{{ timezone }}
      overwrite: true

  files:
    - path: /etc/hostname
      overwrite: true
      contents:
        inline: "{{ inventory_hostname_short }}"

    - path: /etc/systemd/journald.conf.d/10-logging.conf
      overwrite: true
      contents:
        inline: |
          [Journal]
          SystemMaxUse={{ journal_max_size }}
          SystemMaxFileSize={{ journal_max_file_size }}
          MaxRetentionSec={{ journal_retention }}
          ForwardToSyslog=no
          Compress=yes

    - path: /etc/security/limits.d/99-system-limits.conf
      overwrite: true
      contents:
        inline: |
          * soft nofile {{ max_open_files_soft }}
          * hard nofile {{ max_open_files_hard }}
          * soft nproc {{ max_processes_soft }}
          * hard nproc {{ max_processes_hard }}

    # =========================================================================
    # Sysctl: Network buffers and queues
    # =========================================================================
    - path: /etc/sysctl.d/99-network.conf
      overwrite: true
      contents:
        inline: |
          # Network buffer sizes
          net.core.rmem_max = {{ net_rmem_max }}
          net.core.wmem_max = {{ net_wmem_max }}
          net.ipv4.tcp_rmem = {{ tcp_rmem }}
          net.ipv4.tcp_wmem = {{ tcp_wmem }}
          
          # Connection queues
          net.core.netdev_max_backlog = {{ netdev_max_backlog }}
          net.core.somaxconn = {{ somaxconn }}
          net.ipv4.tcp_max_syn_backlog = {{ tcp_max_syn_backlog }}
          
          # Ephemeral port range
          net.ipv4.ip_local_port_range = {{ ip_local_port_range }}
{% if ip_forward | default(false) %}
          
          # IP forwarding
          net.ipv4.ip_forward = 1
          net.ipv6.conf.all.forwarding = 1
{% endif %}

    # =========================================================================
    # Sysctl: TCP tuning
    # =========================================================================
    - path: /etc/sysctl.d/99-tcp-tuning.conf
      overwrite: true
      contents:
        inline: |
          # Congestion control (BBR requires fq qdisc)
          net.core.default_qdisc = {{ default_qdisc }}
          net.ipv4.tcp_congestion_control = {{ tcp_congestion_control }}
          
          # TIME_WAIT optimization
          net.ipv4.tcp_max_tw_buckets = {{ tcp_max_tw_buckets }}
          net.ipv4.tcp_tw_reuse = {{ tcp_tw_reuse }}
          net.ipv4.tcp_fin_timeout = {{ tcp_fin_timeout }}
          
          # Keepalive settings
          net.ipv4.tcp_keepalive_time = {{ tcp_keepalive_time }}
          net.ipv4.tcp_keepalive_intvl = {{ tcp_keepalive_intvl }}
          net.ipv4.tcp_keepalive_probes = {{ tcp_keepalive_probes }}
          
          # Performance optimizations
          net.ipv4.tcp_slow_start_after_idle = {{ tcp_slow_start_after_idle }}
          net.ipv4.tcp_mtu_probing = {{ tcp_mtu_probing }}
          net.ipv4.tcp_fastopen = {{ tcp_fastopen }}

    # =========================================================================
    # Sysctl: Security hardening
    # =========================================================================
    - path: /etc/sysctl.d/99-security.conf
      overwrite: true
      contents:
        inline: |
          # SYN flood protection
          net.ipv4.tcp_syncookies = 1
          
          # Smurf attack protection
          net.ipv4.icmp_echo_ignore_broadcasts = 1
          
          # Kernel hardening
          kernel.dmesg_restrict = 1
          kernel.kptr_restrict = 2
          kernel.yama.ptrace_scope = 1
          
          # Filesystem protection
          fs.protected_hardlinks = 1
          fs.protected_symlinks = 1
          fs.suid_dumpable = 0
          
          # ICMP redirects (CIS Benchmark)
          net.ipv4.conf.all.send_redirects = 0
          net.ipv4.conf.default.send_redirects = 0
          net.ipv4.conf.all.accept_redirects = 0
          net.ipv4.conf.default.accept_redirects = 0
          net.ipv4.conf.all.secure_redirects = 0
          net.ipv4.conf.default.secure_redirects = 0
          net.ipv6.conf.all.accept_redirects = 0
          net.ipv6.conf.default.accept_redirects = 0
          
          # Anti-spoofing (reverse path filtering)
          net.ipv4.conf.all.rp_filter = 1
          net.ipv4.conf.default.rp_filter = 1
          net.ipv4.conf.all.log_martians = 1
          net.ipv4.conf.default.log_martians = 1
{% if disable_ipv6_ra | default(false) %}
          
          # IPv6 Router Advertisement (disabled for static config)
          net.ipv6.conf.all.accept_ra = 0
          net.ipv6.conf.default.accept_ra = 0
{% endif %}

    # =========================================================================
    # Sysctl: VM and memory management
    # =========================================================================
    - path: /etc/sysctl.d/99-vm.conf
      overwrite: true
      contents:
        inline: |
          # Swap behavior (lower = prefer RAM)
          vm.swappiness = {{ vm_swappiness }}
          
          # Dirty page ratios for disk write optimization
          vm.dirty_ratio = {{ vm_dirty_ratio }}
          vm.dirty_background_ratio = {{ vm_dirty_background_ratio }}
          
          # System-wide file descriptor limit
          fs.file-max = {{ fs_file_max }}
          
          # Kernel stability: auto-reboot on panic
          kernel.panic = {{ kernel_panic_timeout }}
          kernel.panic_on_oops = 1

    - path: /etc/systemd/resolved.conf.d/99-security.conf
      overwrite: true
      contents:
        inline: |
          [Resolve]
          # Disable LLMNR (Link-Local Multicast Name Resolution)
          # Prevents LLMNR/NBT-NS poisoning attacks
          LLMNR=no
          # Disable mDNS if not needed
          MulticastDNS=no

    - path: /etc/profile.d/motd.sh
      mode: 0755
      overwrite: true
      contents:
        inline: |
          #!/bin/bash
          
          # Colors
          C='\033[0;36m'
          G='\033[0;32m'
          Y='\033[0;33m'
          D='\033[0;90m'
          N='\033[0m'
          
          # System info
          HOST=$(hostname)
          UP=$(uptime -p | sed 's/up //')
          LOAD=$(cat /proc/loadavg | awk '{print $1, $2, $3}')
          GW_IFACE=$(ip route | awk '/default/ {print $5; exit}')
          
          # Memory
          MU=$(free -m | awk '/Mem:/ {print $3}')
          MT=$(free -m | awk '/Mem:/ {print $2}')
          MP=$((MU * 100 / MT))
          
          # Progress bar
          bar() {
            local p=$1 w=12 f e
            f=$((p * w / 100)); e=$((w - f))
            printf '%s%s' "$(printf '█%.0s' $(seq 1 $f 2>/dev/null))" "$(printf '░%.0s' $(seq 1 $e 2>/dev/null))"
          }
          
          echo ""
          echo -e "${C}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${N}"
          echo -e "  ${G}${HOST}${N} up ${UP}"
          echo -e "${D}  ────────────────────────────────────────────────${N}"
          
          for iface in $(ip -br addr | awk '{print $1}' | grep -v '^lo$'); do
            ip_addr=$(ip -br addr show $iface | awk '{print $3}' | cut -d/ -f1)
            [ -z "$ip_addr" ] && ip_addr="-"
            if [ "$iface" = "$GW_IFACE" ]; then
              printf "  ${Y}%-10s${N} %-15s ${D}← default${N}\n" "$iface" "$ip_addr"
            else
              printf "  ${Y}%-10s${N} %-15s\n" "$iface" "$ip_addr"
            fi
          done
          
          echo -e "${D}  ────────────────────────────────────────────────${N}"
          printf "  ${Y}%-10s${N} %-14s\n" "Load" "${LOAD}"
          printf "  ${Y}%-10s${N} %-14s  %s %2d%%\n" "Memory" "${MU}M / ${MT}M" "$(bar $MP)" "$MP"
          echo -e "${D}  ────────────────────────────────────────────────${N}"
          
          df -BG 2>/dev/null | grep -E '^/dev.*\s+/var' | while read dev size used avail pct mount; do
            used_num=${used%G}
            total_num=${size%G}
            pct_num=${pct%\%}
            mp=$(echo "$mount" | sed 's|^/var||;s|^/||')
            [ -z "$mp" ] && mp="/var"
            printf "  ${Y}%-10s${N} %-14s  %s %2d%%\n" \
              "$mp" "${used_num}G / ${total_num}G" "$(bar $pct_num)" "$pct_num"
          done
          
          echo -e "${C}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${N}"
          echo ""
